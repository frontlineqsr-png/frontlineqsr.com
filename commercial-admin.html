// /assets/commercial-db.js
// Commercial Firestore org-layer DB helpers
// NO PILOT DATA. NO KPI MATH.
// Enterprise-only structure.

import { db } from "./firebase.js";
import {
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  addDoc,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* =========================================================
   Helpers
========================================================= */

function cleanId(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9_-]/g, "_")
    .replace(/_+/g, "_");
}

function now() {
  return serverTimestamp();
}

/* =========================================================
   ORGS
========================================================= */

export async function createOrg({ name, createdByUid, createdByEmail }) {
  if (!name) throw new Error("Org name required.");
  if (!createdByUid) throw new Error("Missing creator UID.");

  const orgRef = doc(collection(db, "orgs"));
  const orgId = orgRef.id;

  await setDoc(orgRef, {
    name,
    createdAt: now(),
    createdByUid,
    createdByEmail,
    active: true
  });

  return orgId;
}

export async function listOrgs() {
  const snap = await getDocs(query(collection(db, "orgs"), orderBy("createdAt", "desc")));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

/* =========================================================
   STORES (org subcollection)
========================================================= */

export async function createStore({ orgId, name, regionId, districtId }) {
  if (!orgId) throw new Error("Org ID required.");
  if (!name) throw new Error("Store name required.");

  const storeId = cleanId(name);

  const storeRef = doc(db, "orgs", orgId, "stores", storeId);

  await setDoc(storeRef, {
    name,
    regionId: regionId || null,
    districtId: districtId || null,
    baselineApproved: false,
    baselineLocked: false,
    active: true,
    createdAt: now()
  });

  return storeId;
}

export async function listStores(orgId) {
  if (!orgId) throw new Error("Org ID required.");

  const snap = await getDocs(
    query(collection(db, "orgs", orgId, "stores"), orderBy("createdAt", "desc"))
  );

  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

/* =========================================================
   USER ACCESS
   Writes to:
   1) /commercial_users/{uid}
   2) /orgs/{orgId}/users/{uid}
========================================================= */

export async function upsertUserAccess({
  uid,
  email,
  orgId,
  role,
  commercialAccess,
  active,
  assignedStoreIds,
  assignedDistrictIds,
  assignedRegionIds,
  isSuperAdmin
}) {
  if (!uid) throw new Error("UID required.");
  if (!email) throw new Error("Email required.");

  // 1️⃣ Global directory
  const dirRef = doc(db, "commercial_users", uid);
  await setDoc(dirRef, {
    email,
    orgId: orgId || null,
    role,
    commercialAccess: !!commercialAccess,
    isSuperAdmin: !!isSuperAdmin,
    active: !!active,
    updatedAt: now()
  }, { merge: true });

  // 2️⃣ Org subcollection (skip for super admin without org)
  if (orgId) {
    const orgUserRef = doc(db, "orgs", orgId, "users", uid);

    await setDoc(orgUserRef, {
      role,
      assignedStoreIds: assignedStoreIds || [],
      assignedDistrictIds: assignedDistrictIds || [],
      assignedRegionIds: assignedRegionIds || [],
      active: !!active,
      updatedAt: now()
    }, { merge: true });
  }

  return true;
}
